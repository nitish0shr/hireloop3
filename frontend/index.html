<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HireLoop Demo</title>
    <!-- TailwindCSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM via CDN -->
    <script crossorigin src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
  </head>
  <body class="bg-gray-50 text-gray-900">
    <div id="app"></div>
    <script type="text/javascript">
      const { useState, useEffect } = React;

      // Simple router using hash
      function Router({ routes }) {
        const [route, setRoute] = useState(window.location.hash.slice(1) || '/');
        useEffect(() => {
          const onHashChange = () => setRoute(window.location.hash.slice(1) || '/');
          window.addEventListener('hashchange', onHashChange);
          return () => window.removeEventListener('hashchange', onHashChange);
        }, []);
        const Component = routes[route] || routes['/'];
        return React.createElement(Component);
      }

      // Main App
      function App() {
        return React.createElement(Router, {
          routes: {
            '/': Home,
            '/role': Role,
          },
        });
      }

      // Home page: Create role
      function Home() {
        const [jdText, setJdText] = useState('');
        const [parsed, setParsed] = useState(null);
        const [roles, setRoles] = useState([]);

        const parseJD = async () => {
          if (!jdText) return;
          const res = await fetch('/functions/v1/parse_jd', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ jd_text: jdText }),
          });
          const data = await res.json();
          setParsed(data.parsed);
        };
        const addRole = () => {
          if (!parsed) return;
          const id = Math.random().toString(36).substr(2, 9);
          setRoles([...roles, { id, parsed }]);
          // store in sessionStorage for navigation
          sessionStorage.setItem('roles', JSON.stringify([...roles, { id, parsed }]));
          // navigate to role page
          location.hash = '/role?id=' + id;
        };
        // On mount, load roles
        useEffect(() => {
          const saved = sessionStorage.getItem('roles');
          if (saved) setRoles(JSON.parse(saved));
        }, []);
        return React.createElement('div', { className: 'p-4 max-w-3xl mx-auto' }, [
          React.createElement('h1', { className: 'text-2xl font-bold mb-4' }, 'HireLoop Demo'),
          React.createElement('p', { className: 'mb-2' }, 'Paste a job description to parse it:'),
          React.createElement('textarea', {
            className: 'w-full p-2 border rounded mb-2 h-32',
            value: jdText,
            onChange: (e) => setJdText(e.target.value),
          }),
          React.createElement('button', {
            className: 'px-4 py-2 bg-blue-600 text-white rounded mr-2',
            onClick: parseJD,
          }, 'Parse JD'),
          parsed && React.createElement('div', { className: 'mt-4 p-4 bg-white border rounded' }, [
            React.createElement('h2', { className: 'font-semibold mb-2' }, 'Parsed JD'),
            React.createElement('pre', { className: 'text-sm whitespace-pre-wrap' }, JSON.stringify(parsed, null, 2)),
            React.createElement('button', {
              className: 'mt-2 px-4 py-2 bg-green-600 text-white rounded',
              onClick: addRole,
            }, 'Create Role'),
          ]),
          roles.length > 0 && React.createElement('div', { className: 'mt-6' }, [
            React.createElement('h2', { className: 'font-semibold mb-2' }, 'Your Roles'),
            React.createElement('ul', { className: 'space-y-2' }, roles.map((r) => React.createElement('li', { key: r.id }, [
              React.createElement('a', { href: '#/role?id=' + r.id, className: 'text-blue-600 hover:underline' }, r.parsed.title || 'Untitled Role'),
            ]))),
          ]),
        ]);
      }

      // Role page: display candidates and actions
      function Role() {
        const params = new URLSearchParams(window.location.hash.split('?')[1]);
        const roleId = params.get('id');
        const [role, setRole] = useState(null);
        const [candidates, setCandidates] = useState([]);
        const [resumeText, setResumeText] = useState('');
        // Load role from sessionStorage
        useEffect(() => {
          const roles = JSON.parse(sessionStorage.getItem('roles') || '[]');
          const r = roles.find((r) => r.id === roleId);
          setRole(r);
          // fetch candidates from server?
        }, [roleId]);
        const screenResume = async () => {
          if (!resumeText) return;
          const res = await fetch('/functions/v1/screen_resume', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ role_id: roleId, resume_text: resumeText }),
          });
          const data = await res.json();
          await loadCandidates();
          alert('Resume screened!');
        };
        const loadCandidates = async () => {
          // In this mock demo we cannot fetch from server; instead we call xray or enrichment functions to update server store
          // We call a dummy endpoint to return current candidates; we use export_shortlist to read; but we can implement a new endpoint or rely on memory.
          // To keep simple, we just call export_shortlist and decode base64 CSV
          const res = await fetch('/functions/v1/export_shortlist', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ role_id: roleId, format: 'csv' }),
          });
          const data = await res.json();
          if (data.url) {
            const csv = atob(data.url.split(',')[1]);
            const lines = csv.split('\n').slice(1).filter(Boolean);
            const candList = lines.map((l, idx) => {
              const [name, company, title, location, fit] = l.split(',');
              return { id: idx.toString(), name, company, current_title: title, location, fit_score: fit };
            });
            setCandidates(candList);
          }
        };
        useEffect(() => { loadCandidates(); }, []);
        const runXraySearch = async () => {
          const res = await fetch('/functions/v1/xray_search', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ role_id: roleId, count: 3 }),
          });
          const leads = await res.json();
          // enrich leads
          await fetch('/functions/v1/apollo_enrich', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ role_id: roleId, leads }),
          });
          await loadCandidates();
        };
        const generateOutreach = async (candId) => {
          const res = await fetch('/functions/v1/generate_outreach', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ role_id: roleId, candidate_id: candId }),
          });
          const data = await res.json();
          alert('Outreach generated:\nSubject: ' + data.subject + '\nBody: ' + data.body);
        };
        const sendSequence = async (candId) => {
          await fetch('/functions/v1/send_sequence', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ candidate_id: candId }),
          });
          await loadCandidates();
        };
        const simulateReply = async (candId) => {
          await fetch('/functions/v1/ingest_webhook', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ candidate_id: candId, event: 'replied' }),
          });
          await loadCandidates();
        };
        const scheduleMeeting = async (candId) => {
          const res = await fetch('/functions/v1/schedule_meeting', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ candidate_id: candId }),
          });
          const data = await res.json();
          alert('Meeting scheduled: ' + data.meetingUrl);
          await loadCandidates();
        };
        const exportShortlist = async () => {
          const res = await fetch('/functions/v1/export_shortlist', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ role_id: roleId, format: 'csv' }),
          });
          const data = await res.json();
          if (data.url) {
            const link = document.createElement('a');
            link.href = data.url;
            link.download = 'shortlist.csv';
            link.click();
          }
        };
        return React.createElement('div', { className: 'p-4 max-w-5xl mx-auto' }, [
          React.createElement('div', { className: 'mb-4' }, [
            React.createElement('a', { href: '#/', className: 'text-blue-600 hover:underline' }, '< Back'),
          ]),
          role && React.createElement('h1', { className: 'text-2xl font-bold mb-2' }, role.parsed.title || 'Role'),
          React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4 mb-6' }, [
            React.createElement('div', { className: 'bg-white p-4 border rounded' }, [
              React.createElement('h2', { className: 'font-semibold mb-2' }, 'Screen a Resume'),
              React.createElement('textarea', {
                className: 'w-full p-2 border rounded mb-2 h-32',
                value: resumeText,
                onChange: (e) => setResumeText(e.target.value),
              }),
              React.createElement('button', {
                className: 'px-4 py-2 bg-blue-600 text-white rounded',
                onClick: screenResume,
              }, 'Screen Resume'),
            ]),
            React.createElement('div', { className: 'bg-white p-4 border rounded' }, [
              React.createElement('h2', { className: 'font-semibold mb-2' }, 'Autonomous Sourcing'),
              React.createElement('button', {
                className: 'px-4 py-2 bg-purple-600 text-white rounded',
                onClick: runXraySearch,
              }, 'Run Xâ€‘ray Search'),
            ]),
          ]),
          React.createElement('h2', { className: 'text-xl font-semibold mb-2' }, 'Candidates'),
          React.createElement('table', { className: 'min-w-full bg-white border' }, [
            React.createElement('thead', null, [
              React.createElement('tr', null, [
                'Name','Company','Title','Location','Fit','Actions'
              ].map((h) => React.createElement('th', { key: h, className: 'px-2 py-1 border-b text-left' }, h))),
            ]),
            React.createElement('tbody', null, candidates.map((c) => React.createElement('tr', { key: c.id, className: 'hover:bg-gray-50' }, [
              React.createElement('td', { className: 'px-2 py-1 border-b' }, c.name),
              React.createElement('td', { className: 'px-2 py-1 border-b' }, c.company),
              React.createElement('td', { className: 'px-2 py-1 border-b' }, c.current_title),
              React.createElement('td', { className: 'px-2 py-1 border-b' }, c.location),
              React.createElement('td', { className: 'px-2 py-1 border-b' }, c.fit_score || ''),
              React.createElement('td', { className: 'px-2 py-1 border-b space-x-2' }, [
                React.createElement('button', { className: 'px-2 py-1 bg-yellow-500 text-white rounded text-xs', onClick: () => generateOutreach(c.id) }, 'Generate Outreach'),
                React.createElement('button', { className: 'px-2 py-1 bg-blue-500 text-white rounded text-xs', onClick: () => sendSequence(c.id) }, 'Send'),
                React.createElement('button', { className: 'px-2 py-1 bg-green-600 text-white rounded text-xs', onClick: () => simulateReply(c.id) }, 'Sim Reply'),
                React.createElement('button', { className: 'px-2 py-1 bg-purple-600 text-white rounded text-xs', onClick: () => scheduleMeeting(c.id) }, 'Schedule'),
              ]),
            ]))),
          ]),
          React.createElement('div', { className: 'mt-4' }, [
            React.createElement('button', { className: 'px-4 py-2 bg-gray-700 text-white rounded', onClick: exportShortlist }, 'Export Shortlist'),
          ]),
        ]);
      }

      ReactDOM.render(React.createElement(App), document.getElementById('app'));
    </script>
  </body>
  <script>
    // Register service worker for PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch((err) => {
        console.error('Service worker registration failed', err);
      });
    }
  </script>
</html>